# RedisæŠ¢è´­ä»£é‡‘åˆ¸ç³»ç»Ÿ - å®Œæ•´æ“ä½œæ‰‹å†Œ

ç§’æ€ç›¸å…³ä»£ç ï¼Œé˜²æ­¢è¶…å–ä¸é™è´­ï¼Œåˆ†å¸ƒå¼é”åº”ç”¨ï¼Œä»¥åŠé”ç›¸å…³ä»£ç 

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
2. [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
3. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
4. [é¡¹ç›®ç¼–è¯‘](#é¡¹ç›®ç¼–è¯‘)
5. [æœåŠ¡å¯åŠ¨](#æœåŠ¡å¯åŠ¨)
6. [åŠŸèƒ½æµ‹è¯•](#åŠŸèƒ½æµ‹è¯•)
7. [Redisæ ¸å¿ƒåŠŸèƒ½éªŒè¯](#redisæ ¸å¿ƒåŠŸèƒ½éªŒè¯)
   - 7.1 [Redisç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯](#71-redisç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯)
   - 7.2 [Redisé˜²æ­¢è¶…å–ï¼ˆLuaè„šæœ¬ï¼‰](#72-redisé˜²æ­¢è¶…å–luaè„šæœ¬)
   - 7.3 [Redisé™åˆ¶ä¸€äººä¸€å•ï¼ˆåˆ†å¸ƒå¼é”ï¼‰](#73-redisé™åˆ¶ä¸€äººä¸€å•åˆ†å¸ƒå¼é”)
8. [JMeterå‹åŠ›æµ‹è¯•](#jmeterå‹åŠ›æµ‹è¯•)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºRedisçš„é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿï¼Œå®ç°äº†ä»£é‡‘åˆ¸æŠ¢è´­åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä½¿ç”¨Redisä½œä¸ºæ ¸å¿ƒæŠ€æœ¯æ¥è§£å†³ç§’æ€åœºæ™¯ä¸­çš„ä¸‰å¤§å…³é”®é—®é¢˜ï¼š

### æ ¸å¿ƒåŠŸèƒ½

1. **Redisç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯**
   - ä½¿ç”¨Redis Hashç»“æ„å­˜å‚¨ç§’æ€åˆ¸æ•°æ®
   - é¿å…é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
   - å‡è½»æ•°æ®åº“å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿååé‡

2. **Redisé˜²æ­¢è¶…å–ï¼ˆLuaè„šæœ¬ï¼‰**
   - ä½¿ç”¨Luaè„šæœ¬å®ç°åŸå­æ€§åº“å­˜æ‰£å‡
   - ä¿è¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹åº“å­˜ä¸ä¼šå‡ºç°è´Ÿæ•°
   - é¿å…è¶…å–é—®é¢˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

3. **Redisé™åˆ¶ä¸€äººä¸€å•ï¼ˆRedissonåˆ†å¸ƒå¼é”ï¼‰**
   - ä½¿ç”¨Redissonå®ç°åˆ†å¸ƒå¼é”æœºåˆ¶
   - é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤æŠ¢è´­
   - æ”¯æŒè‡ªåŠ¨ç»­æœŸï¼ˆçœ‹é—¨ç‹—æœºåˆ¶ï¼‰

### æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Spring Boot 2.3.5
- **å¾®æœåŠ¡**: Spring Cloudï¼ˆEurekaã€OAuth2ï¼‰
- **ç¼“å­˜**: Redis 3.x+
- **åˆ†å¸ƒå¼é”**: Redisson 3.13.6
- **æ•°æ®åº“**: MySQL 5.7+
- **å‹åŠ›æµ‹è¯•**: Apache JMeter 5.6.3

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   JMeterå®¢æˆ·ç«¯   â”‚ (å‹åŠ›æµ‹è¯•)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Eurekaæ³¨å†Œä¸­å¿ƒ  â”‚ (ç«¯å£: 8080)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚OAuth2  â”‚ â”‚ç§’æ€æœåŠ¡â”‚ â”‚ç”¨æˆ·æœåŠ¡  â”‚
â”‚(8082)  â”‚ â”‚(8083)  â”‚ â”‚(8081)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚Redis â”‚     â”‚MySQL â”‚
    â””â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ ç¯å¢ƒè¦æ±‚

- **JDK**: 11.0.26ï¼ˆå¿…é¡»ä½¿ç”¨JDK 11ï¼Œä¸æ”¯æŒJDK 17ï¼‰
- **Maven**: 3.x
- **MySQL**: 5.7+ï¼ˆå¯†ç ï¼š123456ï¼‰
- **Redis**: 3.x+ï¼ˆè™šæ‹Ÿæœºï¼š192.168.153.135:6379ï¼Œæ— å¯†ç ï¼‰
- **æ“ä½œç³»ç»Ÿ**: Windows + Linuxè™šæ‹Ÿæœº

---

## ğŸš€ ç¯å¢ƒå‡†å¤‡

### 1. MySQLæ•°æ®åº“å‡†å¤‡

**è¿è¡Œä½ç½®**: Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰

```bash
# åˆ›å»ºæ•°æ®åº“
mysql -h localhost -u root -p123456 -e "CREATE DATABASE IF NOT EXISTS db_imooc DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

**è¯´æ˜**:
- åˆ›å»ºåä¸º`db_imooc`çš„æ•°æ®åº“
- è™½ç„¶æœ¬å®éªŒä¸»è¦ä½¿ç”¨Redisï¼Œä½†ä»£ç ä¸­ä½¿ç”¨äº†`@Transactional`æ³¨è§£ï¼Œéœ€è¦æ•°æ®åº“è¿æ¥æ‰èƒ½å¯åŠ¨äº‹åŠ¡

### 2. RedisæœåŠ¡å‡†å¤‡

**è¿è¡Œä½ç½®**: Linuxè™šæ‹Ÿæœºï¼ˆ192.168.153.135ï¼‰

```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli -h 192.168.153.135 -p 6379 ping
# é¢„æœŸè¾“å‡º: PONG

# å¦‚æœRedisæœªå¯åŠ¨ï¼Œå¯åŠ¨RedisæœåŠ¡
redis-server /path/to/redis.conf
```

**è¯´æ˜**:
- Redisè¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼ŒIP: 192.168.153.135ï¼Œç«¯å£: 6379
- æ— å¯†ç è®¤è¯

---

## ğŸ”¨ é¡¹ç›®ç¼–è¯‘

**è¿è¡Œä½ç½®**: Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰

**é‡è¦**: å¿…é¡»ä½¿ç”¨JDK 11ç¼–è¯‘ï¼Œå¦åˆ™ä¼šå‡ºç°Lombokå…¼å®¹æ€§é—®é¢˜ã€‚

### 1. è®¾ç½®Javaç¯å¢ƒå˜é‡ï¼ˆæ¯æ¬¡æ‰“å¼€æ–°çš„CMDçª—å£éƒ½éœ€è¦æ‰§è¡Œï¼‰

```bash
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%
```

### 2. ç¼–è¯‘ç§’æ€æœåŠ¡ï¼ˆms-seckillï¼‰

```bash
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-seckill
mvn clean package -DskipTests
```

**é¢„æœŸè¾“å‡º**: `BUILD SUCCESS`

### 3. ç¼–è¯‘Eurekaæ³¨å†Œä¸­å¿ƒï¼ˆms-registryï¼‰

```bash
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-registry
mvn clean package -DskipTests
```

**é¢„æœŸè¾“å‡º**: `BUILD SUCCESS`

### 4. ç¼–è¯‘OAuth2æœåŠ¡ï¼ˆms-oauth2-serverï¼‰

```bash
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-oauth2-server
mvn clean package -DskipTests
```

### 5. ç¼–è¯‘ç”¨æˆ·æœåŠ¡ï¼ˆms-dinersï¼‰

```bash
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-diners
mvn clean package -DskipTests
```

---

## ğŸ¯ æœåŠ¡å¯åŠ¨

**è¿è¡Œä½ç½®**: Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰

**é‡è¦**: å¿…é¡»æŒ‰ç…§ä»¥ä¸‹é¡ºåºå¯åŠ¨æœåŠ¡ï¼Œå¹¶ä¸”æ¯ä¸ªæœåŠ¡éœ€è¦åœ¨å•ç‹¬çš„CMDçª—å£ä¸­è¿è¡Œã€‚

### å¯åŠ¨é¡ºåº

1. **Eurekaæ³¨å†Œä¸­å¿ƒ**ï¼ˆå¿…é¡»ï¼‰
2. **ç§’æ€æœåŠ¡**ï¼ˆå¿…é¡»ï¼‰
3. **OAuth2æœåŠ¡**ï¼ˆå¯é€‰ï¼Œç”¨äºå®Œæ•´æŠ¢è´­æµ‹è¯•ï¼‰
4. **ç”¨æˆ·æœåŠ¡**ï¼ˆå¯é€‰ï¼Œç”¨äºå®Œæ•´æŠ¢è´­æµ‹è¯•ï¼‰

---

### æ­¥éª¤1: å¯åŠ¨Eurekaæ³¨å†Œä¸­å¿ƒ

**æ‰“å¼€CMDçª—å£1**ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# è®¾ç½®Javaç¯å¢ƒ
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%

# å¯åŠ¨Eurekaæ³¨å†Œä¸­å¿ƒ
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-registry\target
java -jar ms-registry-1.0-SNAPSHOT.jar
```

**éªŒè¯å¯åŠ¨æˆåŠŸ**:
- çœ‹åˆ°æ—¥å¿—: `Started RegistryApplication in X seconds`
- è®¿é—®: http://localhost:8080
- åº”è¯¥èƒ½çœ‹åˆ°Eurekaç®¡ç†ç•Œé¢

**è¯´æ˜**:
- Eurekaæ˜¯å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œæ‰€æœ‰æœåŠ¡éƒ½éœ€è¦æ³¨å†Œåˆ°è¿™é‡Œ
- ç«¯å£: 8080
- ä¿æŒæ­¤CMDçª—å£è¿è¡Œï¼Œä¸è¦å…³é—­

---

### æ­¥éª¤2: å¯åŠ¨ç§’æ€æœåŠ¡

**ç­‰å¾…Eurekaå¯åŠ¨å®Œæˆå**ï¼Œæ‰“å¼€**CMDçª—å£2**ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# è®¾ç½®Javaç¯å¢ƒ
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%

# å¯åŠ¨ç§’æ€æœåŠ¡
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-seckill\target
java -jar ms-seckill-1.0-SNAPSHOT.jar
```

**éªŒè¯å¯åŠ¨æˆåŠŸ**:
- çœ‹åˆ°æ—¥å¿—: `Started SeckillApplication in X seconds`
- çœ‹åˆ°æ—¥å¿—: `DiscoveryClient_MS-SECKILL/192.168.203.1:8083 - registration status: 204`
- çœ‹åˆ°æ—¥å¿—: `24 connections initialized for /192.168.153.135:6379`ï¼ˆRedisè¿æ¥æˆåŠŸï¼‰

**è¯´æ˜**:
- ç§’æ€æœåŠ¡æä¾›æ·»åŠ ç§’æ€æ´»åŠ¨å’ŒæŠ¢è´­ä»£é‡‘åˆ¸çš„æ¥å£
- ç«¯å£: 8083
- ä¿æŒæ­¤CMDçª—å£è¿è¡Œï¼Œä¸è¦å…³é—­

---

### æ­¥éª¤3: å¯åŠ¨OAuth2æœåŠ¡ï¼ˆå¯é€‰ï¼‰

**å¦‚æœéœ€è¦æµ‹è¯•å®Œæ•´çš„æŠ¢è´­åŠŸèƒ½**ï¼Œæ‰“å¼€**CMDçª—å£3**ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# è®¾ç½®Javaç¯å¢ƒ
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%

# å¯åŠ¨OAuth2æœåŠ¡
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-oauth2-server\target
java -jar ms-oauth2-server-1.0-SNAPSHOT.jar
```

**è¯´æ˜**:
- OAuth2æœåŠ¡ç”¨äºç”¨æˆ·è®¤è¯å’Œæˆæƒ
- æŠ¢è´­æ¥å£éœ€è¦access_tokenï¼Œç”±æ­¤æœåŠ¡æä¾›

---

### æ­¥éª¤4: å¯åŠ¨ç”¨æˆ·æœåŠ¡ï¼ˆå¯é€‰ï¼‰

**å¦‚æœéœ€è¦æµ‹è¯•å®Œæ•´çš„æŠ¢è´­åŠŸèƒ½**ï¼Œæ‰“å¼€**CMDçª—å£4**ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# è®¾ç½®Javaç¯å¢ƒ
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%

# å¯åŠ¨ç”¨æˆ·æœåŠ¡
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\food-social-contact-parent\ms-diners\target
java -jar ms-diners-1.0-SNAPSHOT.jar
```

**è¯´æ˜**:
- ç”¨æˆ·æœåŠ¡ç®¡ç†ç”¨æˆ·ä¿¡æ¯
- æŠ¢è´­æ—¶éœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•1: æ·»åŠ ç§’æ€æ´»åŠ¨

**å·¥å…·**: Postman æˆ– curl

**æ¥å£**: `POST http://localhost:8083/add`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "fkVoucherId": 1,
  "amount": 100,
  "startTime": "2025-12-11 17:00:00",
  "endTime": "2025-12-11 23:59:59"
}
```

**ä½¿ç”¨curlæµ‹è¯•**ï¼ˆWindows CMDï¼‰:
```bash
curl -X POST http://localhost:8083/add -H "Content-Type: application/json" -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-11 17:00:00\", \"endTime\": \"2025-12-11 23:59:59\"}"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "path": "/add",
  "data": "æ·»åŠ æˆåŠŸ"
}
```

---

### æµ‹è¯•2: éªŒè¯Redisæ•°æ®

**è¿è¡Œä½ç½®**: Linuxè™šæ‹Ÿæœºï¼ˆ192.168.153.135ï¼‰

```bash
# æŸ¥çœ‹ç§’æ€åˆ¸æ•°æ®
redis-cli -h 192.168.153.135 -p 6379 HGETALL "seckill_vouchers:1"
```

**é¢„æœŸè¾“å‡º**:
```
 1) "fkVoucherId"
 2) "1"
 3) "amount"
 4) "100"
 5) "startTime"
 6) "1765443600000"
 7) "endTime"
 8) "1765468740000"
 9) "id"
10) ""
11) "createDate"
12) "1765447356239"
13) "updateDate"
14) "1765447356239"
15) "isValid"
16) "1"
```

**è¯´æ˜**:
- æ•°æ®æˆåŠŸå­˜å‚¨åœ¨Redisçš„Hashç»“æ„ä¸­
- keyæ ¼å¼: `seckill_vouchers:{voucherId}`
- æ—¶é—´æˆ³æ ¼å¼ä¸ºæ¯«ç§’çº§Unixæ—¶é—´æˆ³

---

### æµ‹è¯•3: æŠ¢è´­ä»£é‡‘åˆ¸ï¼ˆéœ€è¦OAuth2æœåŠ¡ï¼‰

**æ¥å£**: `POST http://localhost:8083/{voucherId}?access_token={token}`

**æ­¥éª¤**:
1. å…ˆè·å–access_tokenï¼ˆéœ€è¦OAuth2æœåŠ¡ï¼‰
2. è°ƒç”¨æŠ¢è´­æ¥å£

**ä½¿ç”¨Postmanæµ‹è¯•**:
```
POST http://localhost:8083/1?access_token=your_access_token_here
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "path": "/1",
  "data": "æŠ¢è´­æˆåŠŸ"
}
```

---

## ğŸ¯ Redisæ ¸å¿ƒåŠŸèƒ½éªŒè¯

æœ¬ç« èŠ‚è¯¦ç»†è¯´æ˜Redisåœ¨ç§’æ€ç³»ç»Ÿä¸­çš„ä¸‰å¤§æ ¸å¿ƒåº”ç”¨ï¼Œè¿™æ˜¯æœ¬å®éªŒçš„é‡ç‚¹å†…å®¹ã€‚

---

### 7.1 Redisç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯

#### åŠŸèƒ½è¯´æ˜

ä½¿ç”¨Redis Hashç»“æ„ç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ã€‚

#### å®ç°ä½ç½®

**ä»£ç æ–‡ä»¶**: `ms-seckill/src/main/java/com/imooc/seckill/service/SeckillService.java`

**å…³é”®ä»£ç **ï¼ˆç¬¬74-77è¡Œï¼‰:
```java
// é‡‡ç”¨ Redis ä»ç¼“å­˜ä¸­è·å–ç§’æ€åˆ¸ä¿¡æ¯
String key = RedisKeyConstant.seckill_vouchers.getKey() + voucherId;
Map<String, Object> map = redisTemplate.opsForHash().entries(key);
SeckillVouchers seckillVouchers = BeanUtil.mapToBean(map, SeckillVouchers.class, true, null);
```

**å­˜å‚¨ä»£ç **ï¼ˆç¬¬192-202è¡Œï¼‰:
```java
// é‡‡ç”¨ Redis å®ç°
String key = RedisKeyConstant.seckill_vouchers.getKey() + seckillVouchers.getFkVoucherId();
// éªŒè¯ Redis ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¯¥åˆ¸çš„ç§’æ€æ´»åŠ¨
Map<String, Object> map = redisTemplate.opsForHash().entries(key);
AssertUtil.isTrue(!map.isEmpty() && (int) map.get("amount") > 0, "è¯¥åˆ¸å·²ç»æ‹¥æœ‰äº†æŠ¢è´­æ´»åŠ¨");

// æ’å…¥ Redis
seckillVouchers.setIsValid(1);
seckillVouchers.setCreateDate(now);
seckillVouchers.setUpdateDate(now);
redisTemplate.opsForHash().putAll(key, BeanUtil.beanToMap(seckillVouchers));
```

#### éªŒè¯æ­¥éª¤

**æ­¥éª¤1: æ·»åŠ ç§’æ€æ´»åŠ¨**

åœ¨Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰ä¸­æ‰§è¡Œï¼š

```bash
curl -X POST http://localhost:8083/add -H "Content-Type: application/json" -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-12 00:00:00\", \"endTime\": \"2025-12-12 23:59:59\"}"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "path": "/add",
  "data": "æ·»åŠ æˆåŠŸ"
}
```

**æ­¥éª¤2: åœ¨Redisä¸­æŸ¥çœ‹ç¼“å­˜æ•°æ®**

åœ¨Linuxè™šæ‹Ÿæœºä¸Šæ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹ç§’æ€åˆ¸çš„å®Œæ•´ä¿¡æ¯
redis-cli -h 192.168.153.135 -p 6379 HGETALL "seckill_vouchers:1"
```

**é¢„æœŸè¾“å‡º**:
```
 1) "fkVoucherId"
 2) "1"
 3) "amount"
 4) "100"
 5) "startTime"
 6) "1734019200000"
 7) "endTime"
 8) "1734105599000"
 9) "isValid"
10) "1"
11) "createDate"
12) "1734019356239"
13) "updateDate"
14) "1734019356239"
```

#### æŠ€æœ¯ä¼˜åŠ¿

- âœ… **æ€§èƒ½æå‡**: é¿å…æ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“ï¼Œå“åº”æ—¶é—´ä»æ•°åæ¯«ç§’é™ä½åˆ°å‡ æ¯«ç§’
- âœ… **å‡è½»æ•°æ®åº“å‹åŠ›**: é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ•°æ®åº“æŸ¥è¯¢å‹åŠ›å¤§å¹…é™ä½
- âœ… **æ•°æ®ç»“æ„çµæ´»**: Hashç»“æ„å¯ä»¥å­˜å‚¨å¯¹è±¡çš„å¤šä¸ªå­—æ®µï¼Œä¾¿äºç®¡ç†

---

### 7.2 Redisé˜²æ­¢è¶…å–ï¼ˆLuaè„šæœ¬ï¼‰

#### åŠŸèƒ½è¯´æ˜

ä½¿ç”¨Luaè„šæœ¬å®ç°åŸå­æ€§åº“å­˜æ‰£å‡ï¼Œä¿è¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹åº“å­˜ä¸ä¼šå‡ºç°è´Ÿæ•°ï¼Œä»è€Œé˜²æ­¢è¶…å–é—®é¢˜ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦Luaè„šæœ¬ï¼Ÿ

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœä½¿ç”¨æ™®é€šçš„Rediså‘½ä»¤æ‰£å‡åº“å­˜ï¼š
1. çº¿ç¨‹Aè¯»å–åº“å­˜ï¼š100
2. çº¿ç¨‹Bè¯»å–åº“å­˜ï¼š100
3. çº¿ç¨‹Aæ‰£å‡åº“å­˜ï¼š99
4. çº¿ç¨‹Bæ‰£å‡åº“å­˜ï¼š99ï¼ˆé”™è¯¯ï¼åº”è¯¥æ˜¯98ï¼‰

ä½¿ç”¨Luaè„šæœ¬å¯ä»¥ä¿è¯"è¯»å–-åˆ¤æ–­-æ‰£å‡"è¿™ä¸‰ä¸ªæ“ä½œçš„**åŸå­æ€§**ï¼Œé¿å…å¹¶å‘é—®é¢˜ã€‚

#### å®ç°ä½ç½®

**Luaè„šæœ¬æ–‡ä»¶**: `ms-seckill/src/main/resources/stock.lua`

**å®Œæ•´ä»£ç **:
```lua
-- æ£€æŸ¥åº“å­˜å­—æ®µæ˜¯å¦å­˜åœ¨
if (redis.call('hexists', KEYS[1], KEYS[2]) == 1) then
    -- è·å–å½“å‰åº“å­˜æ•°é‡
    local stock = tonumber(redis.call('hget', KEYS[1], KEYS[2]));
    -- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³
    if (stock > 0) then
        -- åŸå­æ€§æ‰£å‡åº“å­˜ï¼ˆ-1ï¼‰
        redis.call('hincrby', KEYS[1], KEYS[2], -1);
        -- è¿”å›æ‰£å‡å‰çš„åº“å­˜
        return stock;
    end;
    -- åº“å­˜ä¸è¶³ï¼Œè¿”å›0
    return 0;
end;
```

**Javaè°ƒç”¨ä»£ç **: `SeckillService.java`ï¼ˆç¬¬142-148è¡Œï¼‰

```java
// é‡‡ç”¨ Redis + Lua è§£å†³é—®é¢˜
// æ‰£åº“å­˜
List<String> keys = new ArrayList<>();
keys.add(key);              // KEYS[1] = "seckill_vouchers:1"
keys.add("amount");         // KEYS[2] = "amount"
Long amount = (Long) redisTemplate.execute(defaultRedisScript, keys);
AssertUtil.isTrue(amount == null || amount < 1, "è¯¥åˆ¸å·²ç»å–å®Œäº†");
```

#### éªŒè¯æ­¥éª¤

**æ­¥éª¤1: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ**

ç¡®ä¿å·²æ·»åŠ ç§’æ€æ´»åŠ¨ï¼ˆåº“å­˜100ï¼‰ï¼Œå¹¶è·å–access_tokenã€‚

**æ­¥éª¤2: ä½¿ç”¨JMeterè¿›è¡Œå¹¶å‘æµ‹è¯•**

é…ç½®JMeterï¼š
- çº¿ç¨‹æ•°ï¼š100ï¼ˆæ¨¡æ‹Ÿ100ä¸ªç”¨æˆ·åŒæ—¶æŠ¢è´­ï¼‰
- Ramp-Upæ—¶é—´ï¼š1ç§’
- å¾ªç¯æ¬¡æ•°ï¼š1æ¬¡

æ‰§è¡Œæµ‹è¯•åï¼ŒæŸ¥çœ‹Redisä¸­çš„åº“å­˜ï¼š

```bash
# æŸ¥çœ‹å‰©ä½™åº“å­˜
redis-cli -h 192.168.153.135 -p 6379 HGET "seckill_vouchers:1" "amount"
```

**é¢„æœŸç»“æœ**:
- åº“å­˜æ­£ç¡®æ‰£å‡ï¼Œä¸ä¼šå‡ºç°è´Ÿæ•°
- å¦‚æœåˆå§‹åº“å­˜100ï¼Œ100ä¸ªå¹¶å‘è¯·æ±‚åï¼Œåº“å­˜åº”è¯¥æ­£ç¡®å‡å°‘
- é”™è¯¯ç‡ä¸º0%ï¼Œè¯´æ˜Luaè„šæœ¬æ­£ç¡®å¤„ç†äº†æ‰€æœ‰å¹¶å‘è¯·æ±‚

#### æŠ€æœ¯ä¼˜åŠ¿

- âœ… **åŸå­æ€§**: Luaè„šæœ¬åœ¨Redisä¸­ä»¥åŸå­æ–¹å¼æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­
- âœ… **é˜²æ­¢è¶…å–**: ä¿è¯åº“å­˜ä¸ä¼šå˜æˆè´Ÿæ•°
- âœ… **é«˜æ€§èƒ½**: æ‰€æœ‰æ“ä½œåœ¨RedisæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- âœ… **é¿å…ç«æ€æ¡ä»¶**: ä¸éœ€è¦é¢å¤–çš„é”æœºåˆ¶ï¼Œæ€§èƒ½æ›´ä¼˜

---

### 7.3 Redisé™åˆ¶ä¸€äººä¸€å•ï¼ˆåˆ†å¸ƒå¼é”ï¼‰

#### åŠŸèƒ½è¯´æ˜

ä½¿ç”¨Redissonåˆ†å¸ƒå¼é”æœºåˆ¶ï¼Œé˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤æŠ¢è´­åŒä¸€å¼ ä»£é‡‘åˆ¸ï¼Œå®ç°"ä¸€äººä¸€å•"çš„ä¸šåŠ¡è§„åˆ™ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒåŒä¸€ç”¨æˆ·å¯èƒ½é€šè¿‡å¤šä¸ªè¯·æ±‚åŒæ—¶æŠ¢è´­ï¼š
1. è¯·æ±‚Aæ£€æŸ¥ç”¨æˆ·æœªæŠ¢è´­ âœ“
2. è¯·æ±‚Bæ£€æŸ¥ç”¨æˆ·æœªæŠ¢è´­ âœ“
3. è¯·æ±‚Aåˆ›å»ºè®¢å• âœ“
4. è¯·æ±‚Båˆ›å»ºè®¢å• âœ“ï¼ˆé”™è¯¯ï¼ç”¨æˆ·é‡å¤æŠ¢è´­ï¼‰

ä½¿ç”¨åˆ†å¸ƒå¼é”å¯ä»¥ä¿è¯åŒä¸€ç”¨æˆ·åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¯·æ±‚æ‰§è¡ŒæŠ¢è´­é€»è¾‘ã€‚

#### å®ç°ä½ç½®

**ä»£ç æ–‡ä»¶**: `SeckillService.java`ï¼ˆç¬¬105-157è¡Œï¼‰

**å…³é”®ä»£ç **:
```java
// ä½¿ç”¨ Redis é”ä¸€ä¸ªè´¦å·åªèƒ½è´­ä¹°ä¸€æ¬¡
String lockName = RedisKeyConstant.lock_key.getKey()
        + dinerInfo.getId() + ":" + voucherId;
long expireTime = seckillVouchers.getEndTime().getTime() - now.getTime();

// Redisson åˆ†å¸ƒå¼é”
RLock lock = redissonClient.getLock(lockName);

try {
    // Redisson åˆ†å¸ƒå¼é”å¤„ç†
    boolean isLocked = lock.tryLock(expireTime, TimeUnit.MILLISECONDS);
    if (isLocked) {
        // ä¸‹å•
        VoucherOrders voucherOrders = new VoucherOrders();
        voucherOrders.setFkDinerId(dinerInfo.getId());
        voucherOrders.setFkVoucherId(seckillVouchers.getFkVoucherId());
        String orderNo = IdUtil.getSnowflake(1, 1).nextIdStr();
        voucherOrders.setOrderNo(orderNo);
        voucherOrders.setOrderType(1);
        voucherOrders.setStatus(0);
        long count = voucherOrdersMapper.save(voucherOrders);
        AssertUtil.isTrue(count == 0, "ç”¨æˆ·æŠ¢è´­å¤±è´¥");

        // é‡‡ç”¨ Redis + Lua è§£å†³é—®é¢˜
        // æ‰£åº“å­˜
        List<String> keys = new ArrayList<>();
        keys.add(key);
        keys.add("amount");
        Long amount = (Long) redisTemplate.execute(defaultRedisScript, keys);
        AssertUtil.isTrue(amount == null || amount < 1, "è¯¥åˆ¸å·²ç»å–å®Œäº†");
    }
} catch (Exception e) {
    // æ‰‹åŠ¨å›æ»šäº‹åŠ¡
    TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    // Redisson è§£é”
    lock.unlock();
    if (e instanceof ParameterException) {
        return ResultInfoUtil.buildError(0, "è¯¥åˆ¸å·²ç»å–å®Œäº†", path);
    }
}
```

**æ•°æ®åº“æ£€æŸ¥ä»£ç **ï¼ˆç¬¬95-98è¡Œï¼‰:
```java
// åˆ¤æ–­ç™»å½•ç”¨æˆ·æ˜¯å¦å·²æŠ¢åˆ°(ä¸€ä¸ªç”¨æˆ·é’ˆå¯¹è¿™æ¬¡æ´»åŠ¨åªèƒ½ä¹°ä¸€æ¬¡)
VoucherOrders order = voucherOrdersMapper.findDinerOrder(dinerInfo.getId(),
        seckillVouchers.getFkVoucherId());
AssertUtil.isTrue(order != null, "è¯¥ç”¨æˆ·å·²æŠ¢åˆ°è¯¥ä»£é‡‘åˆ¸ï¼Œæ— éœ€å†æŠ¢");
```

#### éªŒè¯æ­¥éª¤

**æ­¥éª¤1: è·å–access_token**

```bash
curl -X POST "http://localhost:8082/oauth/token" ^
  -H "Content-Type: application/x-www-form-urlencoded" ^
  -u "appId:123456" ^
  -d "grant_type=password&username=test&password=123456&scope=api"
```

è®°å½•è¿”å›çš„`accessToken`ã€‚

**æ­¥éª¤2: ç¬¬ä¸€æ¬¡æŠ¢è´­ï¼ˆåº”è¯¥æˆåŠŸï¼‰**

```bash
curl -X POST "http://localhost:8083/1?access_token=your_access_token_here"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "path": "/1",
  "data": "æŠ¢è´­æˆåŠŸ"
}
```

**æ­¥éª¤3: ç¬¬äºŒæ¬¡æŠ¢è´­ï¼ˆåº”è¯¥å¤±è´¥ï¼‰**

ä½¿ç”¨ç›¸åŒçš„access_tokenå†æ¬¡è¯·æ±‚ï¼š

```bash
curl -X POST "http://localhost:8083/1?access_token=your_access_token_here"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "message": "è¯¥ç”¨æˆ·å·²æŠ¢åˆ°è¯¥ä»£é‡‘åˆ¸ï¼Œæ— éœ€å†æŠ¢",
  "path": "/1",
  "data": null
}
```

**æ­¥éª¤4: æŸ¥çœ‹Redisä¸­çš„åˆ†å¸ƒå¼é”**

åœ¨Linuxè™šæ‹Ÿæœºä¸Šæ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹åˆ†å¸ƒå¼é”çš„keyï¼ˆæŠ¢è´­è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ï¼‰
redis-cli -h 192.168.153.135 -p 6379 KEYS "lockby:*"
```

**è¯´æ˜**:
- é”çš„keyæ ¼å¼ï¼š`lockby:{ç”¨æˆ·ID}:{ä»£é‡‘åˆ¸ID}`
- æŠ¢è´­å®Œæˆåï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œæ‰€ä»¥å¯èƒ½æŸ¥è¯¢ä¸åˆ°
- åœ¨é«˜å¹¶å‘æµ‹è¯•æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å¤šä¸ªé”åŒæ—¶å­˜åœ¨

#### æŠ€æœ¯ä¼˜åŠ¿

- âœ… **é˜²æ­¢é‡å¤æŠ¢è´­**: åŒä¸€ç”¨æˆ·åªèƒ½æŠ¢è´­ä¸€æ¬¡
- âœ… **è‡ªåŠ¨ç»­æœŸ**: Redissonçš„çœ‹é—¨ç‹—æœºåˆ¶ï¼Œé˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è¿‡æœŸ
- âœ… **å¯é‡å…¥**: æ”¯æŒå¯é‡å…¥é”ç‰¹æ€§
- âœ… **è‡ªåŠ¨é‡Šæ”¾**: ä¸šåŠ¡å®Œæˆåè‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…æ­»é”

---

### 7.4 Redisä¸‰å¤§åŠŸèƒ½ç»¼åˆéªŒè¯

é€šè¿‡JMeterå‹åŠ›æµ‹è¯•ï¼Œå¯ä»¥ç»¼åˆéªŒè¯Redisçš„ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š

**æµ‹è¯•é…ç½®**:
- å¹¶å‘ç”¨æˆ·æ•°ï¼š100
- åˆå§‹åº“å­˜ï¼š100
- æµ‹è¯•æ—¶é•¿ï¼šçº¦1ç§’

**éªŒè¯ç»“æœ**:
```
æ ·æœ¬æ•°: 100
é”™è¯¯ç‡: 0.00%
å¹³å‡å“åº”æ—¶é—´: 39.52ms
ååé‡: 110.62/ç§’
```

**éªŒè¯é¡¹**:
1. âœ… **Redisç¼“å­˜**: å¹³å‡å“åº”æ—¶é—´ä»…39.52msï¼Œè¯æ˜ç¼“å­˜æœ‰æ•ˆæå‡æ€§èƒ½
2. âœ… **é˜²æ­¢è¶…å–**: é”™è¯¯ç‡0%ï¼Œåº“å­˜æ­£ç¡®æ‰£å‡ï¼Œæ— è´Ÿæ•°
3. âœ… **é™åˆ¶ä¸€äººä¸€å•**: åŒä¸€ç”¨æˆ·å¤šæ¬¡è¯·æ±‚ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æˆåŠŸ

---

## ğŸ“Š JMeterå‹åŠ›æµ‹è¯•

### å‡†å¤‡å·¥ä½œ

**ç¯å¢ƒè¦æ±‚**:
- JMeter 5.3+ (æœ¬é¡¹ç›®ä½¿ç”¨ JMeter 5.6.3)
- æ‰€æœ‰å¾®æœåŠ¡å·²å¯åŠ¨ï¼ˆEurekaã€ç§’æ€æœåŠ¡ã€OAuth2æœåŠ¡ï¼‰
- å·²æ·»åŠ ç§’æ€æ´»åŠ¨å¹¶è·å–access_token

---

### æ­¥éª¤1: è·å–OAuth2è®¿é—®ä»¤ç‰Œ

**è¿è¡Œä½ç½®**: Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰

```bash
# è·å–access_token
curl -X POST "http://localhost:8082/oauth/token" ^
  -H "Content-Type: application/x-www-form-urlencoded" ^
  -u "appId:123456" ^
  -d "grant_type=password&username=test&password=123456&scope=api"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "data": {
    "accessToken": "your-access-token-here",
    "expireIn": 2591999
  }
}
```

**è¯´æ˜**: è®°å½•è¿”å›çš„ `accessToken`ï¼Œåç»­æµ‹è¯•éœ€è¦ä½¿ç”¨ã€‚

---

### æ­¥éª¤2: æ·»åŠ ç§’æ€æ´»åŠ¨

```bash
# æ·»åŠ ç§’æ€æ´»åŠ¨ï¼ˆåº“å­˜100ï¼‰
curl -X POST http://localhost:8083/add ^
  -H "Content-Type: application/json" ^
  -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-12 00:00:00\", \"endTime\": \"2025-12-12 23:59:59\"}"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1,
  "message": "Successful.",
  "path": "/add",
  "data": "æ·»åŠ æˆåŠŸ"
}
```

---

### æ–¹æ³•ä¸€: ä½¿ç”¨JMeterå‘½ä»¤è¡Œæ¨¡å¼ï¼ˆæ¨èç”¨äºæ€§èƒ½æµ‹è¯•ï¼‰

**ä¼˜åŠ¿**: æ€§èƒ½æ›´å¥½ï¼Œé€‚åˆå¤§è§„æ¨¡å‹åŠ›æµ‹è¯•ï¼Œè‡ªåŠ¨ç”ŸæˆHTMLæŠ¥å‘Š

#### 1. ä½¿ç”¨å·²æœ‰çš„æµ‹è¯•è®¡åˆ’æ–‡ä»¶

é¡¹ç›®å·²æä¾›é…ç½®å¥½çš„JMeteræµ‹è¯•è®¡åˆ’æ–‡ä»¶ï¼š`seckill_test.jmx`

**ä¿®æ”¹access_token**ï¼ˆå¦‚æœéœ€è¦ï¼‰:
- ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ `seckill_test.jmx`
- æ‰¾åˆ° `<stringProp name="Argument.value">your-access-token</stringProp>`
- æ›¿æ¢ä¸ºå®é™…çš„access_token

#### 2. æ‰§è¡Œå‹åŠ›æµ‹è¯•

**è¿è¡Œä½ç½®**: Windowså‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill

# æ‰§è¡ŒJMeteræµ‹è¯•ï¼ˆéGUIæ¨¡å¼ï¼‰
E:\apache-jmeter-5.6.3\bin\jmeter.bat -n -t seckill_test.jmx -l test_results.jtl -e -o jmeter_report
```

**å‚æ•°è¯´æ˜**:
- `-n`: éGUIæ¨¡å¼è¿è¡Œ
- `-t`: æŒ‡å®šæµ‹è¯•è®¡åˆ’æ–‡ä»¶
- `-l`: æŒ‡å®šç»“æœè¾“å‡ºæ–‡ä»¶
- `-e`: æµ‹è¯•ç»“æŸåç”ŸæˆHTMLæŠ¥å‘Š
- `-o`: æŒ‡å®šHTMLæŠ¥å‘Šè¾“å‡ºç›®å½•

#### 3. æŸ¥çœ‹æµ‹è¯•ç»“æœ

**å‘½ä»¤è¡Œè¾“å‡ºç¤ºä¾‹**:
```
summary =    100 in 00:00:01 =   98.7/s Avg:    39 Min:     3 Max:   189 Err:     0 (0.00%)
```

**æŸ¥çœ‹è¯¦ç»†HTMLæŠ¥å‘Š**:
åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š`D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\jmeter_report\index.html`

---

### æ–¹æ³•äºŒ: ä½¿ç”¨JMeterå›¾å½¢åŒ–ç•Œé¢ï¼ˆæ¨èç”¨äºå­¦ä¹ å’Œè°ƒè¯•ï¼‰

**ä¼˜åŠ¿**: å¯è§†åŒ–æ“ä½œï¼Œå®æ—¶æŸ¥çœ‹ç»“æœï¼Œä¾¿äºè°ƒè¯•å’Œå­¦ä¹ 

#### 1. å¯åŠ¨JMeterå›¾å½¢åŒ–ç•Œé¢

**æ–¹å¼1: ç›´æ¥å¯åŠ¨å¹¶æ‰“å¼€æµ‹è¯•è®¡åˆ’**
```bash
cd E:\apache-jmeter-5.6.3\bin
start jmeter.bat -t "D:\æˆ‘çš„èµ„æ–™\éå…³ç³»æ•°æ®åº“\seckill-master\seckill\seckill_test.jmx"
```

**æ–¹å¼2: å…ˆå¯åŠ¨JMeterï¼Œå†æ‰“å¼€æ–‡ä»¶**
```bash
# å¯åŠ¨JMeter
E:\apache-jmeter-5.6.3\bin\jmeter.bat

# åœ¨JMeterç•Œé¢ä¸­ï¼š
# ç‚¹å‡» æ–‡ä»¶ â†’ æ‰“å¼€ â†’ é€‰æ‹© seckill_test.jmx
```

#### 2. æŸ¥çœ‹å’Œä¿®æ”¹æµ‹è¯•é…ç½®

**å·¦ä¾§æ ‘å½¢ç»“æ„**:
```
æµ‹è¯•è®¡åˆ’: ç§’æ€å‹åŠ›æµ‹è¯•
â””â”€â”€ çº¿ç¨‹ç»„: ç§’æ€ç”¨æˆ·ç»„
    â”œâ”€â”€ HTTPè¯·æ±‚: æŠ¢è´­ä»£é‡‘åˆ¸
    â”‚   â””â”€â”€ å“åº”æ–­è¨€
    â”œâ”€â”€ å¯Ÿçœ‹ç»“æœæ ‘
    â”œâ”€â”€ èšåˆæŠ¥å‘Š
    â””â”€â”€ æ±‡æ€»æŠ¥å‘Š
```

**ä¿®æ”¹æµ‹è¯•å‚æ•°**ï¼ˆå¯é€‰ï¼‰:
1. ç‚¹å‡»å·¦ä¾§ "ç§’æ€ç”¨æˆ·ç»„"
2. åœ¨å³ä¾§é¢æ¿ä¿®æ”¹ï¼š
   - **çº¿ç¨‹æ•°**: 100ï¼ˆå¹¶å‘ç”¨æˆ·æ•°ï¼‰
   - **Ramp-Upæ—¶é—´**: 1ç§’ï¼ˆå¯åŠ¨æ‰€æœ‰çº¿ç¨‹çš„æ—¶é—´ï¼‰
   - **å¾ªç¯æ¬¡æ•°**: 1ï¼ˆæ¯ä¸ªç”¨æˆ·æ‰§è¡Œçš„æ¬¡æ•°ï¼‰

3. ç‚¹å‡»å·¦ä¾§ "æµ‹è¯•è®¡åˆ’"
4. åœ¨å³ä¾§ "ç”¨æˆ·å®šä¹‰çš„å˜é‡" ä¸­ä¿®æ”¹ï¼š
   - **ACCESS_TOKEN**: æ›¿æ¢ä¸ºå®é™…çš„access_token
   - **HOST**: localhost
   - **PORT**: 8083
   - **VOUCHER_ID**: 1

#### 3. è¿è¡Œæµ‹è¯•

1. **æ¸…é™¤ä¹‹å‰çš„ç»“æœ**ï¼ˆé‡è¦ï¼‰
   - ç‚¹å‡»èœå•ï¼š`è¿è¡Œ` â†’ `æ¸…é™¤å…¨éƒ¨`
   - æˆ–ç‚¹å‡»å·¥å…·æ çš„æ‰«å¸šå›¾æ ‡ ğŸ§¹

2. **å¯åŠ¨æµ‹è¯•**
   - ç‚¹å‡»å·¥å…·æ çš„ç»¿è‰²ä¸‰è§’å½¢æŒ‰é’® â–¶ï¸
   - æˆ–ç‚¹å‡»èœå•ï¼š`è¿è¡Œ` â†’ `å¯åŠ¨`

3. **å®æ—¶æŸ¥çœ‹ç»“æœ**
   - ç‚¹å‡»å·¦ä¾§ **"å¯Ÿçœ‹ç»“æœæ ‘"**
     - ç»¿è‰² = æˆåŠŸï¼Œçº¢è‰² = å¤±è´¥
     - ç‚¹å‡»æŸä¸ªè¯·æ±‚å¯æŸ¥çœ‹è¯¦ç»†çš„è¯·æ±‚å’Œå“åº”å†…å®¹

   - ç‚¹å‡»å·¦ä¾§ **"èšåˆæŠ¥å‘Š"**ï¼ˆæœ€å¸¸ç”¨ï¼‰
     - æ˜¾ç¤ºè¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡æ•°æ®
     - åŒ…æ‹¬æ ·æœ¬æ•°ã€å¹³å‡å€¼ã€ä¸­ä½æ•°ã€ååé‡ç­‰

   - ç‚¹å‡»å·¦ä¾§ **"æ±‡æ€»æŠ¥å‘Š"**
     - æ˜¾ç¤ºç®€åŒ–çš„ç»Ÿè®¡ä¿¡æ¯

#### 4. æ·»åŠ å›¾å½¢åŒ–ç›‘å¬å™¨ï¼ˆå¯é€‰ï¼‰

å³é”®ç‚¹å‡» "ç§’æ€ç”¨æˆ·ç»„" â†’ `æ·»åŠ ` â†’ `ç›‘å¬å™¨` â†’ `å›¾å½¢ç»“æœ`
- å¯ä»¥çœ‹åˆ°å“åº”æ—¶é—´çš„å®æ—¶æ›²çº¿å›¾

---

### æµ‹è¯•é…ç½®è¯´æ˜

**é»˜è®¤æµ‹è¯•é…ç½®**:
```
å¹¶å‘ç”¨æˆ·æ•°: 100
Ramp-Upæ—¶é—´: 1ç§’
å¾ªç¯æ¬¡æ•°: 1æ¬¡
æ€»è¯·æ±‚æ•°: 100ä¸ª

æµ‹è¯•æ¥å£: POST http://localhost:8083/1?access_token={token}
```

**æµ‹è¯•åœºæ™¯å»ºè®®**:

1. **åŸºå‡†æµ‹è¯•**
   - 100ä¸ªç”¨æˆ·ï¼Œ1ç§’å¯åŠ¨ï¼Œå¾ªç¯1æ¬¡
   - è§‚å¯Ÿç³»ç»ŸåŸºæœ¬æ€§èƒ½

2. **é€æ­¥åŠ å‹æµ‹è¯•**
   - ä¾æ¬¡æµ‹è¯•ï¼š50ã€100ã€200ã€500ä¸ªç”¨æˆ·
   - è§‚å¯Ÿæ€§èƒ½å˜åŒ–è¶‹åŠ¿

3. **æŒç»­å‹åŠ›æµ‹è¯•**
   - 100ä¸ªç”¨æˆ·ï¼Œå¾ªç¯10æ¬¡
   - è§‚å¯Ÿç³»ç»Ÿç¨³å®šæ€§

4. **å³°å€¼æµ‹è¯•**
   - 500-1000ä¸ªç”¨æˆ·ï¼Œ1ç§’å¯åŠ¨
   - æµ‹è¯•ç³»ç»Ÿæé™

---

### å…³é”®æ€§èƒ½æŒ‡æ ‡

**åœ¨èšåˆæŠ¥å‘Šä¸­é‡ç‚¹å…³æ³¨**:

| æŒ‡æ ‡ | è¯´æ˜ | æœŸæœ›å€¼ |
|-----|------|--------|
| **æ ·æœ¬** | æ€»è¯·æ±‚æ•° | åº”ç­‰äºçº¿ç¨‹æ•° Ã— å¾ªç¯æ¬¡æ•° |
| **å¹³å‡å€¼** | å¹³å‡å“åº”æ—¶é—´(ms) | < 100ms ä¼˜ç§€ |
| **ä¸­ä½æ•°** | 50%è¯·æ±‚çš„å“åº”æ—¶é—´ | è¶Šå°è¶Šå¥½ |
| **90%ç™¾åˆ†ä½** | 90%è¯·æ±‚çš„å“åº”æ—¶é—´ | < 200ms è‰¯å¥½ |
| **æœ€å°å€¼** | æœ€å¿«å“åº”æ—¶é—´ | å‚è€ƒå€¼ |
| **æœ€å¤§å€¼** | æœ€æ…¢å“åº”æ—¶é—´ | ä¸åº”è¿‡å¤§ |
| **å¼‚å¸¸%** | é”™è¯¯ç‡ | åº”ä¸º 0.00% |
| **ååé‡** | æ¯ç§’å¤„ç†è¯·æ±‚æ•° | è¶Šå¤§è¶Šå¥½ |
| **æ¥æ”¶KB/ç§’** | ç½‘ç»œæ¥æ”¶é€Ÿç‡ | å‚è€ƒå€¼ |
| **å‘é€KB/ç§’** | ç½‘ç»œå‘é€é€Ÿç‡ | å‚è€ƒå€¼ |

**æµ‹è¯•ç»“æœç¤ºä¾‹**:
```
æ ·æœ¬: 100
å¹³å‡å€¼: 39.52 ms
ä¸­ä½æ•°: 5 ms
90%ç™¾åˆ†ä½: 187.2 ms
æœ€å°å€¼: 3 ms
æœ€å¤§å€¼: 189 ms
å¼‚å¸¸%: 0.00%
ååé‡: 110.62/ç§’
```

---

### éªŒè¯Redisåˆ†å¸ƒå¼é”å’ŒLuaè„šæœ¬

**è¿è¡Œä½ç½®**: Linuxè™šæ‹Ÿæœºï¼ˆ192.168.153.135ï¼‰

```bash
# 1. æŸ¥çœ‹å‰©ä½™åº“å­˜
redis-cli -h 192.168.153.135 -p 6379 HGET "seckill_vouchers:1" "amount"

# 2. æŸ¥çœ‹åˆ†å¸ƒå¼é”ï¼ˆå¦‚æœæœ‰ï¼‰
redis-cli -h 192.168.153.135 -p 6379 KEYS "lockby:*"

# 3. æŸ¥çœ‹å®Œæ•´çš„ç§’æ€åˆ¸ä¿¡æ¯
redis-cli -h 192.168.153.135 -p 6379 HGETALL "seckill_vouchers:1"
```

**é¢„æœŸç»“æœ**:
- âœ… åº“å­˜æ­£ç¡®æ‰£å‡ï¼Œä¸ä¼šå‡ºç°è´Ÿæ•°ï¼ˆé˜²æ­¢è¶…å–ï¼‰
- âœ… åŒä¸€ç”¨æˆ·åªèƒ½æŠ¢è´­ä¸€æ¬¡ï¼ˆé˜²æ­¢é‡å¤æŠ¢è´­ï¼‰
- âœ… 100ä¸ªå¹¶å‘è¯·æ±‚åï¼Œåº“å­˜åº”è¯¥å‡å°‘ï¼ˆå…·ä½“æ•°é‡å–å†³äºé˜²é‡å¤æŠ¢è´­æœºåˆ¶ï¼‰

---

### æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

**æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶**:
```
seckill/
â”œâ”€â”€ seckill_test.jmx          # JMeteræµ‹è¯•è®¡åˆ’æ–‡ä»¶
â”œâ”€â”€ test_results.jtl           # æµ‹è¯•ç»“æœåŸå§‹æ•°æ®
â””â”€â”€ jmeter_report/             # HTMLæµ‹è¯•æŠ¥å‘Šç›®å½•
    â”œâ”€â”€ index.html            # æµ‹è¯•æŠ¥å‘Šé¦–é¡µï¼ˆåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼‰
    â”œâ”€â”€ statistics.json       # ç»Ÿè®¡æ•°æ®JSON
    â”œâ”€â”€ content/              # æŠ¥å‘Šå†…å®¹
    â””â”€â”€ sbadmin2-1.0.7/       # æŠ¥å‘Šæ ·å¼
```

**å¯¼å‡ºèšåˆæŠ¥å‘Š**ï¼ˆGUIæ¨¡å¼ï¼‰:
- å³é”®ç‚¹å‡» "èšåˆæŠ¥å‘Š" â†’ `ä¿å­˜è¡¨æ ¼æ•°æ®`
- å¯å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼Œä¾¿äºè¿›ä¸€æ­¥åˆ†æ

---

### æ³¨æ„äº‹é¡¹

1. **æ¯æ¬¡æµ‹è¯•å‰æ¸…é™¤ç»“æœ**ï¼ˆGUIæ¨¡å¼ï¼‰
   - ç‚¹å‡» `è¿è¡Œ` â†’ `æ¸…é™¤å…¨éƒ¨`
   - é¿å…æ•°æ®æ··æ·†

2. **é‡ç½®ç§’æ€æ´»åŠ¨**ï¼ˆå¦‚éœ€é‡å¤æµ‹è¯•ï¼‰
   ```bash
   # åˆ é™¤æ—§çš„ç§’æ€æ´»åŠ¨
   redis-cli -h 192.168.153.135 -p 6379 DEL "seckill_vouchers:1"

   # é‡æ–°æ·»åŠ ç§’æ€æ´»åŠ¨
   curl -X POST http://localhost:8083/add -H "Content-Type: application/json" -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-12 00:00:00\", \"endTime\": \"2025-12-12 23:59:59\"}"
   ```

3. **æµ‹è¯•è§„æ¨¡å»ºè®®**
   - GUIæ¨¡å¼ï¼šé€‚åˆ < 500ä¸ªç”¨æˆ·
   - å‘½ä»¤è¡Œæ¨¡å¼ï¼šé€‚åˆ > 500ä¸ªç”¨æˆ·çš„å¤§è§„æ¨¡æµ‹è¯•

4. **è§‚å¯ŸæœåŠ¡å™¨çŠ¶æ€**
   - æµ‹è¯•æ—¶æ³¨æ„è§‚å¯Ÿåå°æœåŠ¡æ—¥å¿—
   - å¦‚æœå‡ºç°å¤§é‡é”™è¯¯ï¼Œæ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

5. **access_tokenè¿‡æœŸ**
   - å¦‚æœæµ‹è¯•æ—¶å‡ºç°401é”™è¯¯ï¼Œé‡æ–°è·å–access_token
   - é»˜è®¤è¿‡æœŸæ—¶é—´çº¦30å¤©

---

## â“ å¸¸è§é—®é¢˜

### 1. æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š`Unknown database 'db_imooc'`

**åŸå› **: MySQLæ•°æ®åº“æœªåˆ›å»º

**è§£å†³æ–¹æ³•**:
```bash
mysql -h localhost -u root -p123456 -e "CREATE DATABASE IF NOT EXISTS db_imooc DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

---

### 2. æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š`Connection refused: connect` åˆ° Eureka

**åŸå› **: Eurekaæ³¨å†Œä¸­å¿ƒæœªå¯åŠ¨æˆ–æœªå¯åŠ¨å®Œæˆ

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿å…ˆå¯åŠ¨Eurekaæ³¨å†Œä¸­å¿ƒ
2. ç­‰å¾…Eurekaå®Œå…¨å¯åŠ¨ï¼ˆçœ‹åˆ°`Started RegistryApplication`æ—¥å¿—ï¼‰
3. å†å¯åŠ¨å…¶ä»–æœåŠ¡

---

### 3. ç¼–è¯‘å¤±è´¥ï¼š`IllegalAccessError` æˆ– Lomboké”™è¯¯

**åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„Javaç‰ˆæœ¬ï¼ˆå¦‚JDK 17ï¼‰

**è§£å†³æ–¹æ³•**:
1. å¿…é¡»ä½¿ç”¨JDK 11
2. æ¯æ¬¡æ‰“å¼€æ–°çš„CMDçª—å£éƒ½è¦è®¾ç½®JAVA_HOME
```bash
set JAVA_HOME=E:\ProgramsFiles\Java\JDK11.0.26
set PATH=%JAVA_HOME%\bin;%PATH%
```

---

### 4. Redisæ•°æ®ä¸ºç©ºæˆ–æŸ¥è¯¢ä¸åˆ°

**åŸå› **:
- Redis keyåç§°é”™è¯¯ï¼ˆæ³¨æ„æ˜¯ä¸‹åˆ’çº¿`seckill_vouchers:1`ï¼Œä¸æ˜¯å†’å·`seckill:vouchers:1`ï¼‰
- æ·»åŠ ç§’æ€æ´»åŠ¨æ—¶æ•°æ®åº“æœªåˆ›å»ºï¼Œå¯¼è‡´äº‹åŠ¡å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# 1. åˆ é™¤ç©ºçš„key
redis-cli -h 192.168.153.135 -p 6379 DEL "seckill_vouchers:1"

# 2. é‡æ–°è°ƒç”¨æ·»åŠ ç§’æ€æ´»åŠ¨æ¥å£
curl -X POST http://localhost:8083/add -H "Content-Type: application/json" -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-11 17:00:00\", \"endTime\": \"2025-12-11 23:59:59\"}"

# 3. éªŒè¯æ•°æ®
redis-cli -h 192.168.153.135 -p 6379 HGETALL "seckill_vouchers:1"
```

---

### 5. æ·»åŠ ç§’æ€æ´»åŠ¨è¿”å›"è¯¥åˆ¸å·²ç»æ‹¥æœ‰äº†æŠ¢è´­æ´»åŠ¨"

**åŸå› **: Redisä¸­å·²å­˜åœ¨è¯¥åˆ¸çš„ç§’æ€æ´»åŠ¨

**è§£å†³æ–¹æ³•**:
```bash
# åˆ é™¤å·²å­˜åœ¨çš„ç§’æ€æ´»åŠ¨
redis-cli -h 192.168.153.135 -p 6379 DEL "seckill_vouchers:1"

# é‡æ–°æ·»åŠ 
curl -X POST http://localhost:8083/add -H "Content-Type: application/json" -d "{\"fkVoucherId\": 1, \"amount\": 100, \"startTime\": \"2025-12-11 17:00:00\", \"endTime\": \"2025-12-11 23:59:59\"}"
```

---

### 6. æ—¶é—´æ ¡éªŒé”™è¯¯ï¼š"ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´"

**åŸå› **: ä»£ç ä¸­çš„æ—¶é—´æ ¡éªŒé€»è¾‘æœ‰bugï¼ˆå·²ä¿®å¤ï¼‰

**å·²ä¿®å¤ä½ç½®**: `SeckillService.java:181`

**ä¿®å¤å†…å®¹**:
```java
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
AssertUtil.isTrue(now.after(seckillVouchers.getEndTime()), "ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´");

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
AssertUtil.isTrue(seckillVouchers.getEndTime().before(now), "ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´");
```

---

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯ç‚¹

### 1. Redisç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯

**ä½ç½®**: `SeckillService.java:75-77`

```java
String key = RedisKeyConstant.seckill_vouchers.getKey() + voucherId;
Map<String, Object> map = redisTemplate.opsForHash().entries(key);
SeckillVouchers seckillVouchers = BeanUtil.mapToBean(map, SeckillVouchers.class, true, null);
```

**ä¼˜åŠ¿**:
- é¿å…æ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“
- æå‡æŸ¥è¯¢æ€§èƒ½
- å‡è½»æ•°æ®åº“å‹åŠ›

---

### 2. Redissonåˆ†å¸ƒå¼é”

**ä½ç½®**: `SeckillService.java:114-157`

```java
RLock lock = redissonClient.getLock(lockName);
boolean isLocked = lock.tryLock(expireTime, TimeUnit.MILLISECONDS);
if (isLocked) {
    // æ‰§è¡ŒæŠ¢è´­é€»è¾‘
}
```

**åŠŸèƒ½**:
- é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤æŠ¢è´­
- è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼ˆçœ‹é—¨ç‹—ï¼‰
- å¯é‡å…¥é”ç‰¹æ€§

---

### 3. Luaè„šæœ¬åŸå­æ€§æ‰£å‡åº“å­˜

**ä½ç½®**: `SeckillService.java:142-148`ï¼Œ`stock.lua`

```lua
if (redis.call('hexists', KEYS[1], KEYS[2]) == 1) then
    local stock = tonumber(redis.call('hget', KEYS[1], KEYS[2]));
    if (stock > 0) then
       redis.call('hincrby', KEYS[1], KEYS[2], -1);
       return stock;
    end;
    return 0;
end;
```

**ä¼˜åŠ¿**:
- ä¿è¯åº“å­˜æ‰£å‡çš„åŸå­æ€§
- é˜²æ­¢è¶…å–é—®é¢˜
- é¿å…å¹¶å‘é—®é¢˜

---

## ğŸ“ å®éªŒæŠ¥å‘Šè¦ç‚¹

1. **Redisåœ¨ç§’æ€ç³»ç»Ÿä¸­çš„ä¸‰å¤§åº”ç”¨**
   - ç¼“å­˜ç§’æ€åˆ¸ä¿¡æ¯ï¼ˆHashç»“æ„ï¼‰
   - åˆ†å¸ƒå¼é”ï¼ˆRedissonï¼‰
   - åŸå­æ€§åº“å­˜æ‰£å‡ï¼ˆLuaè„šæœ¬ï¼‰

2. **è§£å†³çš„æŠ€æœ¯é—®é¢˜**
   - æ—¶é—´æ ¡éªŒé€»è¾‘é”™è¯¯ä¿®å¤
   - Javaç‰ˆæœ¬å…¼å®¹æ€§ï¼ˆä½¿ç”¨Java 11ï¼‰
   - å¾®æœåŠ¡å¯åŠ¨é¡ºåº
   - Redisæ•°æ®å­˜å‚¨éªŒè¯

3. **ç³»ç»Ÿä¼˜åŠ¿**
   - é«˜å¹¶å‘å¤„ç†èƒ½åŠ›
   - é˜²æ­¢è¶…å–
   - é˜²æ­¢é‡å¤æŠ¢è´­
   - æ€§èƒ½ä¼˜åŒ–ï¼ˆRedisç¼“å­˜ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æ–™

- Rediså®˜æ–¹æ–‡æ¡£: https://redis.io/documentation
- Redissonå®˜æ–¹æ–‡æ¡£: https://github.com/redisson/redisson
- Spring Bootå®˜æ–¹æ–‡æ¡£: https://spring.io/projects/spring-boot

---


---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ç›®çš„ã€‚
