-- ============================================================
-- 补充历史订单数据（2025-12-20 ~ 2025-12-26）
-- 目的：让管理后台/报表页有可展示的历史数据
--
-- 注意：
-- - 项目启用了“防重复预约”触发器（trg_prevent_duplicate_order）
-- - 如果历史订单里存在“同一玩家 + 同一场次”的重复预约，会被触发器拦截并报错
-- - 因此本脚本采用“临时表 + NOT EXISTS”方式：遇到冲突自动跳过，不会中断执行
-- ============================================================

SET NAMES utf8mb4;

SET @before_cnt := (SELECT COUNT(*) FROM T_Order);

DROP TEMPORARY TABLE IF EXISTS tmp_history_orders;
CREATE TEMPORARY TABLE tmp_history_orders (
  Order_ID BIGINT NOT NULL,
  Player_ID BIGINT NOT NULL,
  Schedule_ID BIGINT NOT NULL,
  Amount DECIMAL(10,2) NOT NULL,
  Pay_Status TINYINT NOT NULL,
  Create_Time DATETIME NOT NULL,
  PRIMARY KEY (Order_ID)
) ENGINE=MEMORY;

INSERT INTO tmp_history_orders (Order_ID, Player_ID, Schedule_ID, Amount, Pay_Status, Create_Time) VALUES
  -- 12月20日（5笔）
  (5101, 3015, 4001, 168.00, 1, '2025-12-20 09:15:00'),
  (5102, 3016, 4001, 168.00, 1, '2025-12-20 10:30:00'),
  (5103, 3017, 4002, 198.00, 1, '2025-12-20 11:20:00'),
  (5104, 3018, 4002, 198.00, 1, '2025-12-20 14:45:00'),
  (5105, 3019, 4003, 158.00, 1, '2025-12-20 16:30:00'),

  -- 12月21日（6笔）
  (5106, 3020, 4003, 158.00, 1, '2025-12-21 08:30:00'),
  (5107, 3021, 4004, 218.00, 1, '2025-12-21 10:15:00'),
  (5108, 3022, 4004, 218.00, 1, '2025-12-21 11:45:00'),
  (5109, 3023, 4005, 188.00, 1, '2025-12-21 13:20:00'),
  (5110, 3024, 4005, 188.00, 1, '2025-12-21 15:00:00'),
  (5111, 3025, 4006, 138.00, 1, '2025-12-21 17:30:00'),

  -- 12月22日（7笔）
  (5112, 3026, 4006, 138.00, 1, '2025-12-22 09:00:00'),
  (5113, 3027, 4007, 178.00, 1, '2025-12-22 10:30:00'),
  (5114, 3028, 4007, 178.00, 1, '2025-12-22 11:15:00'),
  (5115, 3029, 4008, 168.00, 1, '2025-12-22 13:45:00'),
  (5116, 3030, 4008, 168.00, 1, '2025-12-22 14:20:00'),
  (5117, 3031, 4009, 208.00, 1, '2025-12-22 16:00:00'),
  (5118, 3032, 4009, 208.00, 1, '2025-12-22 17:30:00'),

  -- 12月23-26日（20笔）
  (5119, 3033, 4010, 188.00, 1, '2025-12-23 09:30:00'),
  (5120, 3034, 4010, 188.00, 1, '2025-12-23 11:00:00'),
  (5121, 3035, 4011, 198.00, 1, '2025-12-23 13:15:00'),
  (5122, 3036, 4011, 198.00, 1, '2025-12-23 14:45:00'),
  (5123, 3037, 4012, 158.00, 1, '2025-12-23 16:20:00'),
  (5124, 3038, 4012, 158.00, 1, '2025-12-24 10:00:00'),
  (5125, 3039, 4013, 168.00, 1, '2025-12-24 11:30:00'),
  (5126, 3040, 4013, 168.00, 1, '2025-12-24 13:00:00'),
  (5127, 3041, 4014, 198.00, 1, '2025-12-24 15:15:00'),
  (5128, 3042, 4014, 198.00, 1, '2025-12-24 16:45:00'),
  (5129, 3043, 4015, 158.00, 1, '2025-12-25 09:00:00'),
  (5130, 3044, 4015, 158.00, 1, '2025-12-25 10:30:00'),
  (5131, 3045, 4016, 218.00, 1, '2025-12-25 12:00:00'),
  (5132, 3046, 4016, 218.00, 1, '2025-12-25 14:00:00'),
  (5133, 3047, 4017, 188.00, 1, '2025-12-25 16:30:00'),
  (5134, 3048, 4017, 188.00, 1, '2025-12-26 08:45:00'),
  (5135, 3049, 4018, 138.00, 1, '2025-12-26 10:15:00'),
  (5136, 3050, 4018, 138.00, 1, '2025-12-26 11:45:00'),
  (5137, 3015, 4019, 178.00, 1, '2025-12-26 13:30:00'),
  (5138, 3016, 4019, 178.00, 1, '2025-12-26 15:00:00');

SET @attempted := (SELECT COUNT(*) FROM tmp_history_orders);

-- 核心：若已存在“有效预约(0/1)”则跳过，避免触发器报错
INSERT IGNORE INTO T_Order (Order_ID, Player_ID, Schedule_ID, Amount, Pay_Status, Create_Time)
SELECT t.Order_ID, t.Player_ID, t.Schedule_ID, t.Amount, t.Pay_Status, t.Create_Time
FROM tmp_history_orders t
WHERE NOT EXISTS (
  SELECT 1
  FROM T_Order o
  WHERE o.Player_ID = t.Player_ID
    AND o.Schedule_ID = t.Schedule_ID
    AND o.Pay_Status IN (0, 1)
  LIMIT 1
);

SET @after_cnt := (SELECT COUNT(*) FROM T_Order);

SET @inserted := (@after_cnt - @before_cnt);
SET @skipped := (@attempted - @inserted);

SELECT CONCAT(
  'OK: history orders attempted=', @attempted,
  ', inserted=', @inserted,
  ', skipped(conflict/exist)=', @skipped
) AS Status;
